#!/bin/bash
set -e

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–±–æ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é

DEPLOY_PATH="/var/www/doorhan-mega"
LOG_FILE="${DEPLOY_PATH}/logs/build.log"
MAX_RETRIES=3
RETRY_DELAY=10

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "${DEPLOY_PATH}/logs"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏
check_memory() {
    local free_mb=$(free -m | awk 'NR==2{printf "%.0f", $4}')
    log "–î–æ—Å—Ç—É–ø–Ω–æ –ø–∞–º—è—Ç–∏: ${free_mb}MB"
    
    if [ "$free_mb" -lt 512 ]; then
        log "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–∞–ª–æ —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏ (${free_mb}MB). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 512MB"
        return 1
    fi
    
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
cleanup() {
    log "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
    cd "$DEPLOY_PATH"
    
    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É
    rm -rf .next
    
    # –û—á–∏—â–∞–µ–º –∫—ç—à npm
    npm cache clean --force 2>/dev/null || true
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    find . -type f -name "*.tsbuildinfo" -delete 2>/dev/null || true
    find . -type d -name ".turbo" -exec rm -rf {} + 2>/dev/null || true
    
    log "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∫–∏ —Å retry
build_with_retry() {
    local attempt=1
    
    while [ $attempt -le $MAX_RETRIES ]; do
        log "üèóÔ∏è  –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ #${attempt} –∏–∑ ${MAX_RETRIES}..."
        
        cd "$DEPLOY_PATH"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–º—è—Ç—å –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        if ! check_memory; then
            log "‚ö†Ô∏è  –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏. –û–∂–∏–¥–∞–Ω–∏–µ ${RETRY_DELAY} —Å–µ–∫—É–Ω–¥..."
            sleep $RETRY_DELAY
            attempt=$((attempt + 1))
            continue
        fi
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
        if [ $attempt -eq 1 ]; then
            # –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ - –æ–±—ã—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
            log "üì¶ –ó–∞–ø—É—Å–∫ –æ–±—ã—á–Ω–æ–π —Å–±–æ—Ä–∫–∏..."
            if NODE_OPTIONS='--max-old-space-size=2048' npm run build >> "$LOG_FILE" 2>&1; then
                log "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
                return 0
            fi
        elif [ $attempt -eq 2 ]; then
            # –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞
            log "üì¶ –ó–∞–ø—É—Å–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–±–æ—Ä–∫–∏ (–º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏)..."
            if NODE_OPTIONS='--max-old-space-size=1536 --no-warnings' npm run build >> "$LOG_FILE" 2>&1; then
                log "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
                return 0
            fi
        else
            # –¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞ - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞
            log "üì¶ –ó–∞–ø—É—Å–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏ (—ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏)..."
            if NODE_OPTIONS='--max-old-space-size=1024 --no-warnings' npm run build >> "$LOG_FILE" 2>&1; then
                log "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
                return 0
            fi
        fi
        
        log "‚ùå –ü–æ–ø—ã—Ç–∫–∞ #${attempt} –Ω–µ —É–¥–∞–ª–∞—Å—å. –û–∂–∏–¥–∞–Ω–∏–µ ${RETRY_DELAY} —Å–µ–∫—É–Ω–¥..."
        sleep $RETRY_DELAY
        attempt=$((attempt + 1))
    done
    
    log "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–±–æ—Ä–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å!"
    return 1
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "üöÄ –ù–∞—á–∞–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ ! -d "$DEPLOY_PATH" ]; then
        log "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $DEPLOY_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
        exit 1
    fi
    
    # –û—á–∏—Å—Ç–∫–∞
    cleanup
    
    # –°–±–æ—Ä–∫–∞ —Å retry
    if build_with_retry; then
        log "üéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ -f "${DEPLOY_PATH}/.next/BUILD_ID" ]; then
            log "‚úÖ BUILD_ID –Ω–∞–π–¥–µ–Ω - —Å–±–æ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–∞"
            exit 0
        else
            log "‚ùå BUILD_ID –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–±–æ—Ä–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞"
            exit 1
        fi
    else
        log "‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫"
        exit 1
    fi
}

# –ó–∞–ø—É—Å–∫
main

